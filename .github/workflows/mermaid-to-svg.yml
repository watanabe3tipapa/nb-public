name: Render Mermaid to SVG

on:
  push:
    paths:
      - "**/*.mmd"
      - "**/*.mermaid"
  workflow_dispatch:

jobs:
  render-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install mermaid-cli
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Find and Render Mermaid files
        id: render
        run: |
          #!/bin/bash
          # Find all .mmd and .mermaid files tracked by git
          mapfile -t files < <(git ls-files '**/*.mmd' '**/*.mermaid')

          if [ ${#files[@]} -eq 0 ]; then
            echo "No Mermaid files found to render."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Rendering ${#files[@]} file(s):"
          for file in "${files[@]}"; do
            output_file="${file%.*}.svg"
            if [[ "$file" == *.mermaid ]]; then
              output_file="${file%.mermaid}.svg"
            fi
            echo "  - $file -> $output_file"
            mmdc -i "$file" -o "$output_file" -b transparent --puppeteerConfigFile puppeteer-config.json
          done

          echo "has_changes=true" >> "$GITHUB_OUTPUT"

      - name: Commit and Push SVG files
        if: steps.render.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Render Mermaid files to SVG"
          file_pattern: "**/*.svg"
