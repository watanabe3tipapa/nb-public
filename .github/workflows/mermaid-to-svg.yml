name: Render Mermaid to SVG

on:
  push:
    paths:
      - "**/*.mmd"
      - "**/*.mermaid"
      - "**/*.md"
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install mermaid-cli
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Find and render Mermaid files
        id: find_and_render
        run: |
          # Find native .mmd and .mermaid files
          git ls-files '*.mmd' '*.mermaid' > mermaid_files.txt || true

          # Find and extract mermaid blocks from .md files
          for md in $(git ls-files '*.md' || true); do
            sanitized_name=$(echo "$md" | tr -c 'a-zA-Z0-9' '_')
            awk -v s_name="$sanitized_name" 'BEGIN{in_block=0; count=0} /^```mermaid/{in_block=1; count++; filename=sprintf("md_mermaid_%s_%s.mmd", s_name, count); next} /^```/{if(in_block){in_block=0}} {if(in_block){print >> filename}}' "$md"
          done

          # Add extracted files to the list if they exist
          if ls md_mermaid_*.mmd 1>/dev/null 2>&1; then
            ls md_mermaid_*.mmd >> mermaid_files.txt
          fi

          if [ ! -s mermaid_files.txt ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No Mermaid files found to render."
            exit 0
          fi

          echo "Rendering files..."
          while IFS= read -r file; do
            [ -f "$file" ] || continue

            # For extracted markdown blocks, the output name is tricky.
            # We will place them in an `assets` folder for now.
            if [[ "$file" == md_mermaid_*.mmd ]]; then
              # Create a name based on the temp filename. e.g., md_mermaid_docs_usage_md_1.svg
              output_file="assets/${file%.mmd}.svg"
              mkdir -p assets
            else
              # For native files, place SVG alongside the source file
              output_file="${file%.*}.svg"
            fi

            echo "  - $file -> $output_file"
            mmdc -i "$file" -o "$output_file" -b transparent || { echo "mmdc failed for $file"; exit 1; }
          done < mermaid_files.txt

          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Commit and Push SVG files
        if: steps.find_and_render.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Render Mermaid files to SVG"
          file_pattern: "**/*.svg"
